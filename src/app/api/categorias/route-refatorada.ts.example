import { withAuth } from "@/lib/api-auth";
import { readFileSync, writeFileSync } from "fs";
import { join } from "path";
import { randomUUID } from "crypto";

const DATA_PATH = join(process.cwd(), "src/data/categorias.json");

function readCategorias() {
  try {
    const data = readFileSync(DATA_PATH, "utf8");
    return JSON.parse(data);
  } catch (error) {
    return [];
  }
}

function writeCategorias(categorias: any[]) {
  writeFileSync(DATA_PATH, JSON.stringify(categorias, null, 2));
}

// ✅ GET - Buscar categorias do usuário logado
export const GET = withAuth(async (request, token) => {
  try {
    const categorias = readCategorias();
    
    // Filtra apenas categorias do usuário logado
    const userCategorias = categorias.filter(
      (cat: any) => cat.userId === token.id
    );
    
    return Response.json(userCategorias);
  } catch (error) {
    console.error("Erro ao buscar categorias:", error);
    return Response.json(
      { error: "Erro interno do servidor" }, 
      { status: 500 }
    );
  }
});

// ✅ POST - Criar nova categoria
export const POST = withAuth(async (request, token) => {
  try {
    const body = await request.json();
    const { nome } = body;

    if (!nome) {
      return Response.json(
        { error: "Nome é obrigatório" }, 
        { status: 400 }
      );
    }

    const categorias = readCategorias();
    
    const novaCategoria = {
      id: randomUUID(),
      nome,
      userId: token.id, // ✅ Vincula ao usuário logado automaticamente
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    };

    categorias.push(novaCategoria);
    writeCategorias(categorias);
    
    return Response.json(novaCategoria, { status: 201 });
  } catch (error) {
    console.error("Erro ao criar categoria:", error);
    return Response.json(
      { error: "Erro interno do servidor" }, 
      { status: 500 }
    );
  }
});
